import bt
import pandas as pd
import matplotlib.pyplot as plt
from sklearn import preprocessing
import numpy as np

class vci():

    def __init__(self, ticker, start, end,
                 macd_n, macd_m,
                 rsi_n,rsi_m,
                 so_n, so_m,
                 fc_window):

        self.ticker = ticker #defines the ticker symbol
        self.start = start  #start date of backtest
        self.end = end    #ends backtest
        self.macd_n = macd_n       #MACD short sma window
        self.macd_m = macd_m        #MACD long sma window
        self.rsi_n = rsi_n
        self.rsi_m = rsi_m
        self.so_n = so_n
        self.so_m = so_m
        self.fc_window = fc_window


    def above_macd(self,x):
        short_sma = x.rolling(self.macd_n).mean()
        long_sma = x.rolling(self.macd_m).mean()
        macd = (short_sma - long_sma)
        return (macd)

    def scaler(self, x):
        df = x.iloc[:, :]
          #creates a copy and makes it empty to fill values to
        for i in range(len(df)):
            tw = df.copy()
            tw = tw.iloc[fc_window:]
            tw[self.ticker] = np.nan
            if i > self.fc_window and i + 1 < len(df) :
                # print('position i: %s' %(i))
                dist_calc = df[i - self.fc_window:i]
                dist_calc_min = dist_calc.min()
                dist_calc_max = dist_calc.max()
                curr_value = x.iloc[i + 1]
                # print('curr_date: %s curr_value: %s date: %s dist_min: %s dist_max: %s' %(curr_date, curr_value, dist_date, dist_min, dist_max))
                min = -1  # min weight
                max = 1  # max weight

                today_std = ((curr_value - dist_calc_min) / (dist_calc_max - dist_calc_min))
                today_scaled = ((today_std * (max - min)) + min)
                #tw.append(today_scaled, ignore_index=True)
                return today_scaled  #####this needs to fill in the nan dataframe called tw!!!!!!!



    def wrapper(self,x):   #wraps the weights to be parsed into the strategy
        macd = self.above_macd(x)
        signal = macd.copy()
        tw = pd.DataFrame(self.scaler(signal))    #this makes the trading weights
        return tw


ticker = 'spy'
start = '2013-01-01'
end = '2018-06-06'
macd_n = 10
macd_m = 26
rsi_n = 14
rsi_m = 10
so_n = 14
so_m = 3
fc_window = 252
i = vci(ticker, start, end,
                 macd_n, macd_m,
                 rsi_n,rsi_m,
                 so_n, so_m, fc_window)

data = bt.get('spy',start = start,end = end)
print(i.wrapper(data))
'''
s = bt.Strategy('weights',
                        [bt.algos.WeighTarget(i.wrapper()),
                        bt.algos.RunAfterDays(260),   #this lets our dataframe for weight allocation fill first
                         bt.algos.Rebalance()],
                        [ticker])
t = bt.Backtest(s,data)

res = bt.run(t)
'''

#use df to store data
#df to store weights
#create variable to store weights, list or array
